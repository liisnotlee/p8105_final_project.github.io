---
title: "EXERCISE AND HORMONE PATTERNS"
author: "Anu Singh"
date: "2025-11-18"
output: html_document
---
Examine the Exercise-Cycle Relationship such as the pattern of calories and activity level across menstrual phases and whether it associated with hormone or stress changes (scatterplot), and multivariable linear regression that includes stress score, sleep time, exercise time, exercise activities, and menstrual phases. 

Datasets:

* hormones_and_selfreport.csv
* exercise.csv

### Load libraries

```{r setup, message = FALSE}
# Load libraries
library(tidyverse)

```

### Data import/cleaning/merging
```{r, message = FALSE, warning = FALSE}

# Read data
exercise = read_csv("./data/exercise.csv")
hormones = read_csv("./data/hormones_and_selfreport.csv")


# Clean and un-duplicate exercise data
exercise_clean = exercise %>%
  distinct() %>%
  select(id, study_interval, start_day_in_study, 
         activityname, calories, duration, activeduration, 
         averageheartrate, steps, elevationgain)

# Aggregate to daily level
exercise_daily = exercise_clean %>%
  group_by(id, study_interval, start_day_in_study) %>%
  summarise(
    total_calories = sum(calories, na.rm = TRUE),
    total_duration_min = sum(duration, na.rm = TRUE) / 60000,
    total_active_min = sum(activeduration, na.rm = TRUE) / 60000,
    total_steps = sum(steps, na.rm = TRUE),
    avg_heartrate = mean(averageheartrate, na.rm = TRUE),
    max_heartrate = max(averageheartrate, na.rm = TRUE),
    total_elevation = sum(elevationgain, na.rm = TRUE),
    n_sessions = n(),
    activity_types = paste(unique(activityname), collapse = ", "),
    .groups = "drop"
  ) %>%
  rename(day_in_study = start_day_in_study)

# Convert Likert scales to numeric
likert_to_num <- c("Very Low/Little" = 1, "Low" = 2, "Moderate" = 3, 
                   "High" = 4, "Very High" = 5)

hormones_clean = hormones %>%
  mutate(
    stress_num = recode(stress, !!!likert_to_num),
    fatigue_num = recode(fatigue, !!!likert_to_num),
    cramps_num = recode(cramps, !!!likert_to_num),
    sleepissue_num = recode(sleepissue, !!!likert_to_num),
    exerciselevel_num = recode(exerciselevel, !!!likert_to_num),
    appetite_num = recode(appetite, !!!likert_to_num),
    bloating_num = recode(bloating, !!!likert_to_num),
    moodswing_num = recode(moodswing, !!!likert_to_num),
    # Order phase factor for proper plotting
    phase = factor(phase, levels = c("Menstrual", "Follicular", "Fertility", "Luteal"))
  )

# Merge datasets
merged_data = hormones_clean %>%
  left_join(exercise_daily, by = c("id", "study_interval", "day_in_study")) %>%
  mutate(
    total_calories = replace_na(total_calories, 0),
    total_duration_min = replace_na(total_duration_min, 0),
    total_active_min = replace_na(total_active_min, 0),
    total_steps = replace_na(total_steps, 0),
    n_sessions = replace_na(n_sessions, 0),
    total_elevation = replace_na(total_elevation, 0),
    # Binary: did they exercise today?
    exercised_today = ifelse(n_sessions > 0, "Yes", "No")
  ) %>% 
  filter(!is.na(phase)) # maybe filter out phase that is NA?
  
```


### Analysis
### 1. Exercise duration and calories burned across phases
```{r}

# Boxplot: Exercise duration by phase
ggplot(merged_data %>% filter(total_duration_min > 0), 
       aes(x = phase, y = total_duration_min, fill = phase)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(alpha = 0.1, width = 0.2) +
  facet_wrap(~study_interval) +
  labs(title = "Exercise Duration Across Menstrual Phases",
       x = "Menstrual Phase", 
       y = "Total Exercise Duration (minutes)") +
  theme_minimal() +
  theme(legend.position = "none")

# Boxplot: Calories burned by phase (faceted by study interval)
ggplot(merged_data %>% filter(total_calories > 0), 
       aes(x = phase, y = total_calories, fill = phase)) +
  geom_boxplot(alpha = 0.7) +
  facet_wrap(~study_interval) +
  labs(title = "Exercise Calories by Phase",
       x = "Menstrual Phase", 
       y = "Calories Burned") +
  theme_minimal() +
  theme(legend.position = "none")
```

### Heart rate during exercise across phases
```{r}
# Average heart rate during exercise by phase
ggplot(merged_data %>% filter(!is.na(avg_heartrate)), 
       aes(x = phase, y = avg_heartrate, fill = phase)) +
  geom_boxplot(width = 0.2, alpha = 0.8) +
  facet_wrap(~study_interval) +
  labs(title = "Exercise Intensity (Heart Rate) by Menstrual Phase",
       x = "Menstrual Phase", 
       y = "Average Heart Rate (bpm)") +
  theme_minimal() +
  theme(legend.position = "none")
```

### Likelihood of exercising across phases
```{r}
# Calculate total proportion of days where exercise sessions > 0 
exercise_likelihood = merged_data %>%
  group_by(phase, study_interval) %>%
  summarise(
    total_days = n(), # total no. of observations
    exercise_days = sum(n_sessions > 0), # total no. of sessions logged on that day
    proportion = exercise_days / total_days, 
    .groups = "drop"
  )

ggplot(exercise_likelihood, aes(x = phase, y = proportion, fill = phase)) +
  geom_col(alpha = 0.8) +
  geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)), 
            vjust = -0.5) +
  facet_wrap(~study_interval) +
  labs(title = "Likelihood of Exercising by Menstrual Phase",
       x = "Menstrual Phase", 
       y = "Proportion of Days with Exercise") +
  scale_y_continuous(labels = scales::percent, limits = c(0, 0.7)) +
  theme_minimal() +
  theme(legend.position = "none")
```


### Hormone levels vs. exercise duration
```{r}
# NOT TO INCLUDE, DOES NOT REALLY OFFER ANY INSIGHT
# Estrogen vs exercise duration
ggplot(merged_data %>% filter(total_duration_min > 0), 
       aes(x = estrogen, y = total_duration_min, color = phase)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(title = "Estrogen Level vs Exercise Duration",
       x = "Estrogen (ng/mL)", 
       y = "Exercise Duration (min)",
       color = "Phase") +
  theme_minimal()

# LH (luteinizing hormone) vs exercise
ggplot(merged_data %>% filter(total_duration_min > 0), 
       aes(x = lh, y = total_duration_min, color = phase)) +
  geom_point(alpha = 0.5) +
  labs(title = "Luteinizing Hormone vs Exercise Duration",
       subtitle = "LH goes down during ovulation/fertility",
       x = "LH (mIU/mL)", 
       y = "Exercise Duration (min)",
       color = "Phase") +
  theme_minimal()

# Progesterone (PdG) vs exercise duration
ggplot(merged_data %>% filter(total_duration_min > 0 & !is.na(pdg)), 
       aes(x = pdg, y = total_duration_min, color = phase)) +
  geom_point(alpha = 0.5) +
  labs(title = "Progesterone (PdG) vs Exercise Duration",
       subtitle = "PdG goes up in luteal phase",
       x = "PdG (mcg/mL)", 
       y = "Exercise Duration (min)",
       color = "Phase") +
  theme_minimal()
```


### Comparing menstrual symptoms to exercise duration
```{r}
# Stress vs Exercise
ggplot(merged_data %>% filter(!is.na(stress_num) & total_duration_min > 0), 
       aes(x = factor(stress_num), y = total_duration_min, fill = phase)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Self-Reported Stress vs Exercise Duration",
       x = "Stress Level (1=Very Low, 5=Very High)", 
       y = "Exercise Duration (min)",
       fill = "Phase") +
  theme_minimal()

# Fatigue vs. exercise
ggplot(merged_data %>% filter(!is.na(fatigue_num) & total_duration_min > 0), 
       aes(x = factor(fatigue_num), y = total_duration_min)) +
  geom_boxplot(alpha = 0.7, fill = "steelblue") +
  labs(title = "Fatigue Level vs Exercise Duration",
       x = "Fatigue (1=Very Low, 5=Very High)", 
       y = "Exercise Duration (min)") +
  theme_minimal()

# Cramps vs Exercise (tried to observe by menstrual phases, too little data, plots don't generate nicely)
ggplot(merged_data %>% filter(!is.na(cramps_num), total_duration_min > 0), 
       aes(x = factor(cramps_num), y = total_duration_min)) +
  geom_boxplot(fill = "steelblue", alpha = 0.7) +
  # geom_jitter(alpha = 0.2, width = 0.2) +  # Add points to see data
  labs(title = "Cramp Severity vs Exercise Duration",
       x = "Cramps (1=Very Low, 5=Very High)", 
       y = "Exercise Duration (min)") +
  theme_minimal()
```
### Comparing self-reported exercise results to objective measures
```{r}
# Don't really see any relationship. Same average durations reported across all groups
# No alignment between exercise intensity and actual exercise duration

ggplot(merged_data %>% filter(!is.na(exerciselevel_num), total_duration_min > 0), 
       aes(x = exerciselevel_num, y = total_duration_min)) +
  geom_jitter(alpha = 0.3, width = 0.2, height = 0, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "darkblue") +
  labs(title = "Self-Reported vs Objective Exercise Level",
       subtitle = "How well does perception match Fitbit data?",
       x = "Self-Reported Exercise Level (1=Very Low, 5=Very High)", 
       y = "Fitbit-Measured Duration (min)") +
  theme_minimal()
```

# Spaghetti plot: looking at individual exercise durations over different phases
```{r}
# Mean exercise by phase for each participant
individual_patterns = merged_data %>%
  group_by(id, phase) %>%
  summarise(mean_duration = mean(total_duration_min, na.rm = TRUE),
            .groups = "drop")

ggplot(individual_patterns, aes(x = phase, y = mean_duration, group = id)) +
  geom_line(alpha = 0.3) +
  geom_point(alpha = 0.3) +
  stat_summary(aes(group = 1), fun = mean, geom = "line", 
               color = "red", size = 1.5) +
  stat_summary(aes(group = 1), fun = mean, geom = "point", 
               color = "red", size = 3) +
  labs(title = "Individual Exercise Patterns Across Phases",
       subtitle = "Red line = group mean",
       x = "Menstrual Phase", 
       y = "Mean Exercise Duration (min)") +
  theme_minimal()

# Don't really see much variation, seems exercise duration does not change dramatically across phases
```
### Summary statistics
```{r}

merged_data %>%
  group_by(phase) %>%
  summarise(
    n_observations = n(),
    mean_duration = mean(total_duration_min, na.rm = TRUE),
    sd_duration = sd(total_duration_min, na.rm = TRUE),
    mean_calories = mean(total_calories, na.rm = TRUE),
    mean_heartrate = mean(avg_heartrate, na.rm = TRUE),
    percent_exercised = mean(n_sessions > 0) * 100,
    mean_stress = mean(stress_num, na.rm = TRUE),
    mean_fatigue = mean(fatigue_num, na.rm = TRUE),
    .groups = "drop"
  )
```

**IMPORTANT**: Should 2024 data be included? Any testing that requires the independence assumption would be violated. 
- For descriptives, can facet them by interval, or do weighted descriptives, so each individual contributes equally to the analysis

### Inferential analysis
```{r}
# install.packages("lme4")
# install.packages("lmerTest")
# install.packages("broom.mixed")
# install.packages("ggeffects")
library(lme4)
library(lmerTest)
library(broom.mixed)
library(ggeffects)
```

```{r}
# Preparing analysis dataset
analysis_data = merged_data %>%
  mutate(study_interval = factor(study_interval))

# Checking data structure
cat("Total observations:", nrow(analysis_data), "\n")
cat("Unique participants:", n_distinct(analysis_data$id), "\n")
cat("Study intervals:", unique(analysis_data$study_interval), "\n")
```
#### Exercising and symptoms

- Let's see if exercising helps with symptom severity
- Doing mixed-effect modelling
- Want to know effect of exercise on symptoms are controlling for individual differences
- Included phase and ID to account for differences in symptoms by phase and individual differences
```{r}
# Model 1: Exercise → cramps
model_cramps = lmer(cramps_num ~ total_duration_min + phase + (1|id), 
                     data = analysis_data,
                     REML = FALSE)
summary(model_cramps)

# Model 2: Exercise → fatigue
model_fatigue = lmer(fatigue_num ~ total_duration_min + phase + (1|id), 
                      data = analysis_data,
                      REML = FALSE)
summary(model_fatigue)

# Model 3: Exercise → stress
model_stress = lmer(stress_num ~ total_duration_min + phase + (1|id), 
                     data = analysis_data,
                     REML = FALSE)
summary(model_stress)

# Model 4: Exercise → mood swings
model_mood = lmer(moodswing_num ~ total_duration_min + phase + (1|id), 
                   data = analysis_data,
                   REML = FALSE)
summary(model_mood)

# Model 5: Exercise → sleep issues
model_sleep = lmer(sleepissue_num ~ total_duration_min + phase + (1|id), 
                    data = analysis_data,
                    REML = FALSE)
summary(model_sleep)

# Model 6: Exercise → bloating
model_bloating = lmer(bloating_num ~ total_duration_min + phase + (1|id), 
                    data = analysis_data,
                    REML = FALSE)
summary(model_bloating)

# Model 7: Exercise → appetite
model_appetite = lmer(appetite_num ~ total_duration_min + phase + (1|id), 
                    data = analysis_data,
                    REML = FALSE)
summary(model_appetite)

 
```

```{r}
# Cleaning results:
# Extract coefficients for exercise effect
results_summary = bind_rows(
  tidy(model_cramps, effects = "fixed") %>% mutate(outcome = "Cramps"),
  tidy(model_fatigue, effects = "fixed") %>% mutate(outcome = "Fatigue"),
  tidy(model_stress, effects = "fixed") %>% mutate(outcome = "Stress"),
  tidy(model_mood, effects = "fixed") %>% mutate(outcome = "Mood swings"),
  tidy(model_sleep, effects = "fixed") %>% mutate(outcome = "Sleep issues"),
  tidy(model_bloating, effects = "fixed") %>% mutate(outcome = "Bloating"),
  tidy(model_appetite, effects = "fixed") %>% mutate(outcome = "Appetite")
) %>%
  filter(term == "total_duration_min") %>%
  select(outcome, estimate, std.error, statistic, p.value) %>%
  mutate(
    significant = ifelse(p.value < 0.05, "Yes", "No"),
    p.value = format.pval(p.value, digits = 3, eps = 0.001)
  )

print("Summary of exercise effects on symptoms:")
print(results_summary)
```
#### Testing for interaction
- Looking at whether any of the above symptoms differ by phase
- Interaction is insignificant in all models
```{r}
# Interaction models
# Cramps
model_cramps_int = lmer(cramps_num ~ total_duration_min * phase + (1|id), 
                         data = analysis_data,
                         REML = FALSE)
summary(model_cramps_int)

# Testing if interaction is significant
anova(model_cramps, model_cramps_int)

# Fatigue
model_fatigue_int =  lmer(fatigue_num ~ total_duration_min * phase + (1|id), 
                          data = analysis_data,
                          REML = FALSE)
anova(model_fatigue, model_fatigue_int)

# Stress
model_stress_int = lmer(stress_num ~ total_duration_min * phase + (1|id), 
                         data = analysis_data,
                         REML = FALSE)
anova(model_stress, model_stress_int)

# Moodswing
model_mood_int = lmer(moodswing_num ~ total_duration_min * phase + (1|id), 
                         data = analysis_data,
                         REML = FALSE)
anova(model_mood, model_mood_int)

# Sleepissue
model_sleep_int = lmer(sleepissue_num ~ total_duration_min * phase + (1|id), 
                         data = analysis_data,
                         REML = FALSE)
anova(model_sleep, model_sleep_int)

# bloating
model_bloating_int = lmer(bloating_num ~ total_duration_min * phase + (1|id), 
                         data = analysis_data,
                         REML = FALSE)
anova(model_bloating, model_bloating_int)

# appetite
model_appetite_int = lmer(appetite_num ~ total_duration_min * phase + (1|id), 
                         data = analysis_data,
                         REML = FALSE)
anova(model_appetite, model_appetite_int)
```



