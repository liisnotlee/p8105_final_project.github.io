---
title: "SLEEP & STRESS: EXPLORATORY DATA ANALYSIS"
output:
  html_document:
    code_folding: hide 
---

```{r setup , include = FALSE}
library(tidyverse)
library(ggplot2)
library(modelr)
library(mgcv) # for cross validation
library(dplyr)
library(tidyr)
library(patchwork)
library(lme4)
library(lmerTest)
library(rstatix)
library(ggpubr)
library(FSA)# for Dunn test
library(broom.mixed) # for tidy

set.seed(1)

# Set plot theme
theme_set(theme_minimal() + 
            theme(legend.position = "bottom",
                  axis.title = element_text(size = 14),
                  axis.text = element_text(size = 12)))
options(
  ggplot2.discrete.colour = function(...) scale_colour_brewer(..., palette = "Pastel2"),
  ggplot2.discrete.fill   = function(...) scale_fill_brewer(..., palette = "Pastel2"),

  ggplot2.continuous.colour = function(...) scale_colour_distiller(..., palette = "PuRd"),
  ggplot2.continuous.fill   = function(...) scale_fill_distiller(..., palette = "PuRd")
)
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
all_data_df = 
  read_csv("clean_data/all_daily_data.csv") |>
  janitor::clean_names()
subject_info = 
  read_csv("clean_data/subject_info.csv") |>
  janitor::clean_names() |>
  select(id, ethnicity, education_abrv)
sleep_stress_df = all_data_df|>
  filter(!is.na(stress_score) & !is.na(sleep_score) & !is.na(timeinbed_mean)) |>
  select(id, study_interval, day_in_study, phase, lh, estrogen, sleep_score, stress_score, timeinbed_mean, deep_sleep_in_minutes, total_active_min, moodswing_score) |>
  mutate(
    phase = fct_relevel(phase,"menstrual", "follicular", "fertility", "luteal")
  )
sleep_stress_df = full_join(subject_info, sleep_stress_df, join_by(id))
```

<br>

This page examines how sleep quality, time in bed, deep sleep, and stress levels vary across menstrual cycle phases, with additional comparisons across ethnic groups.

<br>

## Sleep Time Across Participants and Year

The average sleep time for each person is different each study interval and varied across participants.  In 2022, some participants slept less than 5 hours and some slept more than 8 hours. In 2024, most participants have better sleep length, 7-8 hours. 
```{r, message=FALSE, warning=FALSE}
# plot the mean timein bed in hour
  sleep_stress_df |>
  filter(!is.na(study_interval)) |>
  ggplot(aes(x = id, y = timeinbed_mean/60, group = id, color = id))+
  geom_boxplot()+
  facet_grid(study_interval ~.) +
  labs(
    x = "Participant",
    y = "Average time in bed (hours)"
  ) 

```

<br>

## Sleep & Stress Metrics

The dataset has some stress score values equal zero which could be from an input error. This skewed the stress score histogram. We then remove the zero value for further analysis. Other continuous variables of our interest are normally distributed. 
```{r, warning = FALSE}
sleep_stress_df |> 
  select(stress_score,sleep_score, timeinbed_mean, deep_sleep_in_minutes) |> 
  pivot_longer(everything()) |> 
  ggplot(aes(value)) + 
  geom_histogram(bins = 30, fill = "lightblue") +
  facet_wrap(~ name, scales = "free")
# remove zero value in stress score
sleep_stress_df = 
  sleep_stress_df |>
  filter(stress_score != 0)
  
```
Menstruators spent more time in bed during the menstrual phase; however, their deep-sleep duration was lowest during this period. This pattern suggests that although increased physical fatigue during menstruation may prompt individuals to rest longer, it may simultaneously impair the ability to achieve restorative sleep. In contrast, during the follicular phase—when individuals typically experience higher energy levels—participants spent less time in bed but obtained greater amounts of deep sleep.

<br>

### Sleep & Stress Metrics Across Menstrual Phases
```{r,message=FALSE, warning=FALSE}
# plot the variation of time in bed by menstrual phases
timeinbed_plot =
  sleep_stress_df|>
  filter(!is.na(study_interval) & !is.na(phase)) |>
  group_by(phase, id) |>
  summarize(
    timeinbed = mean(timeinbed_mean/60)
  )|> 
  ggplot(aes(x = phase, y = timeinbed, fill = phase)) +
  geom_violin(alpha = 0.5, width = 0.5)+
  geom_boxplot(width = 0.2)+
  labs(
    x = " ",
    y = "Time in bed (hrs)"
  ) +
    theme(legend.position = "none") 
# plot the variation of deep sleep score by menstrual phases
deep_sleep_plot =
   sleep_stress_df|>
  filter(!is.na(study_interval) & !is.na(phase)) |>
  group_by(phase, id) |>
  summarize(
    mean_deep_sleep = mean(deep_sleep_in_minutes/60)
  )|> 
  ggplot(aes(x = phase, y = mean_deep_sleep, fill = phase)) +
  geom_violin(alpha = 0.5, width = 0.5)+
  geom_boxplot(width = 0.2)+
  labs(
    x = " ",
    y = "Deep sleep (hrs)"
  ) +
    theme(legend.position = "none") 
# plot the variation of sleep score by menstrual phases
sleep_score_boxplot =
  sleep_stress_df |>
  filter(!is.na(study_interval) & !is.na(phase)) |>
  ggplot(aes(x = phase, y = sleep_score, fill = phase))+
 geom_violin(alpha = 0.5, width = 0.5)+
  geom_boxplot(width = 0.2)+
  labs(
    x = " ",
    y = "Sleep score"
  ) +
  theme(legend.position = "none")
# plot the variation of stress score by menstrual phases
stress_score_boxplot =
  sleep_stress_df |>
  filter(!is.na(study_interval) & !is.na(phase)) |>
  filter(stress_score != 0)|>
    ggplot(aes(x = phase, y = stress_score, fill = phase))+
  geom_violin(alpha = 0.5, width = 0.5)+
  geom_boxplot(width = 0.2)+
  labs(
    x = " ",
    y = "Stress score"
  ) +
  theme(legend.position = "none")

(timeinbed_plot|deep_sleep_plot)/
(sleep_score_boxplot |stress_score_boxplot)
```

We further examined variations in stress scores across the menstrual cycle. Overall sleep quality scores were highest during the menstrual phase, indicating that participants may benefit from prioritizing rest during this time. The lowest sleep scores were observed during the ovulatory (fertile) window, a period characterized by elevated estrogen and luteinizing hormone (LH) concentrations, which may contribute to reduced sleep quality. In this scoring system, higher values indicate lower perceived stress. Participants exhibited the lowest stress levels during the follicular phase, consistent with increased energy and improved well-being. Conversely, the highest stress levels were recorded during the luteal phase.

```{r, warning= FALSE, message=FALSE}
# plot the sleep vs stress score by phases
plot_1 = 
  sleep_stress_df |>
  group_by(phase) |>
  summarize(
    mean_sleep_score = mean(sleep_score, na.rm = TRUE),
    mean_stress_score = mean(stress_score, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_longer(
    cols = starts_with("mean_"),
    names_to = "metric",
    values_to = "value"
  ) |>
  mutate(
    metric = recode(metric,
                    mean_sleep_score  = "Sleep Score",
                    mean_stress_score = "Stress Score")
  ) |>
  ggplot(aes(x = phase, y = value, color = metric, group = metric)) +
    geom_smooth(linewidth= 1) +
    geom_point(size = 3) +
    labs(color = "Metric", y = "Mean Score", x = "Phase") +
    labs(
    x = "Menstrual Cycle Phase",
    y = "Score"
  ) +
    theme_minimal() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1))
# plot the hormone changes
coeff = 5.5
plot_2  =
  sleep_stress_df |>
  group_by(phase) |>
  summarize(
    mean_lh = mean(lh, na.rm = TRUE),
    mean_estrogen = mean( estrogen, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_longer(
    cols = starts_with("mean_"),
    names_to = "metric",
    values_to = "value"
  ) |>
  mutate(
    metric = recode(metric,
                    mean_lh           = "LH",
                    mean_estrogen     = "Estrogen")
  ) |>
  ggplot(aes(x = phase, y = value, color = metric, group = metric)) +
    geom_smooth(linewidth= 1) +
    geom_point(size = 3) +
    labs(color = "Metric", y = "level", x = "Phase") +
    labs(
    x = "Menstrual Cycle Phase",
    y = "Level"
  ) +
    theme_minimal() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1))
# Plot the time in bed and deep sleep in minutes in phases
plot_3 = 
  sleep_stress_df |>
  group_by(phase)|>
   summarize(
     mean_timeinbed = mean(timeinbed_mean/60, na.rm = TRUE),
    mean_deep_sleep_in_minutes = mean((deep_sleep_in_minutes/60)*coeff, na.rm = TRUE)
             )|>
  pivot_longer(
    cols = starts_with("mean_"),
    names_to = "metric",
    values_to = "value"
  ) |>
  mutate(
    metric = recode(metric,
                    mean_timeinbed             = "Time in bed (hours)",
                    mean_deep_sleep_in_minutes = "Deep sleep (hours)")
  ) |>
  ggplot(aes(x = phase, y = value, color = metric, group = metric)) +
    geom_smooth(linewidth= 1) +
    geom_point(size = 3) +
    labs(color = "Metric", y = "level", x = "Phase") +
    labs(
    x = "Menstrual Cycle Phase",
    y = "Level"
  ) +
  scale_y_continuous(
    
    # Features of the first axis
    name = "Time in bed (hours)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./coeff, name="Deep sleep (hours)")
  ) +
    theme_minimal() +
  theme(legend.position = "bottom",
         legend.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1))
plot_1 + plot_2 + plot_3
```

<br>

### Sleep & Stress Metrics Across Menstrual Phases & Ethnicites 

The figure illustrates mean sleep and stress scores across menstrual cycle phases, stratified by ethnicity. Overall, sleep scores show modest fluctuations across phases, with most groups exhibiting slightly higher sleep quality during the menstrual phase and lower scores during the fertility (ovulatory) phase. This pattern is most pronounced in the Middle Eastern group, which demonstrates a steady decline in sleep score from the menstrual to the luteal phase. Other groups, including East Asian, Southeast Asian, Latina, and White participants, show relatively stable sleep scores with minor dips during the fertility phase.

Stress scores follow a similar cyclical pattern, with most ethnic groups reporting lower perceived stress (higher stress scores) during the follicular phase and higher perceived stress (lower stress scores) during the luteal phase. The Latina group shows the most pronounced fluctuation, with a peak in stress score during the follicular phase and a marked decline during the luteal phase. East Asian, Southeast Asian, and White participants show smaller but consistent shifts that align with expected hormonal changes across the menstrual cycle.

Together, these trends suggest that both sleep quality and perceived stress vary systematically across menstrual phases, with ovulation associated with reduced sleep quality and the luteal phase associated with increased stress. While the magnitude of these changes differs across ethnic groups, the overall pattern remains consistent, highlighting a cyclical relationship between physiological rhythms and well-being.

```{r, message=FALSE, warning=FALSE}
sleep_stress_df |>
  group_by(phase, ethnicity) |>
  summarize(
    mean_sleep_score = mean(sleep_score, na.rm = TRUE),
    mean_stress_score = mean(stress_score, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_longer(
    cols = starts_with("mean_"),
    names_to = "metric",
    values_to = "value"
  ) |>
  drop_na()|>
  mutate(
    metric = recode(metric,
                    mean_sleep_score  = "Sleep Score",
                    mean_stress_score = "Stress Score")
  ) |>
  ggplot(aes(x = phase, y = value, color = ethnicity, group = ethnicity)) +
    geom_line(size = 1) +
    geom_point(size = 3) +
    facet_grid(~ metric) +
    labs(color = "Ethnicity", y = "Mean Score", x = "Phase") +
    labs(
    title = "Stress and Sleep Score Across Menstrual Cycle Phases",
    x = "Menstrual Cycle Phase",
    y = "score"
  ) +
    theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


