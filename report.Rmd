---
title: "Report"
html_document:
    code_folding: hide
---

```{r, include=FALSE}
# Load packages 
library(tidyverse)
library(ggplot2)
library(modelr)
library(mgcv)
library(dplyr)
library(tidyr)
library(patchwork)
library(lme4)
library(lmerTest)
library(ggsci)

# Set plot theme
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.discrete.colour = function(...) scale_colour_brewer(..., palette = "Pastel2"),
  ggplot2.discrete.fill   = function(...) scale_fill_brewer(..., palette = "Pastel2"),

  ggplot2.continuous.colour = function(...) scale_colour_distiller(..., palette = "PuRd"),
  ggplot2.continuous.fill   = function(...) scale_fill_distiller(..., palette = "PuRd")
)
```

# Motivation
Half of the world's population has experineced or will experience menstruation; for many, this physiologic function occurs monthly for several decades. For young adults who menstruate, symptoms and regular menstration can be a vital health indicator. Abnormal symptoms can further suggest reproductive tract abnormalities, such as uterine fibroids or endometriosis. However, abnormal symptoms such as heavy bleeding or extreme pain can also be attributed to lifestyle characteristics. By leveraging a cohort of young adult menstruators, we hope to better understand the relationship between physiological menstrual characteristics and lifestyle factors such as stress, sleep, and exercise. Understanding how day-to-day factors influence menstrual health can help individuals who menstruate understand how to better manage concerning symptoms or identify when abnormal symptoms could be indicative of a more serious health concern. 

# Related Work

# Questions


# Data

We utilized the inclusive, multimodal, longitudinal, and de-identified [mcPHASES](https://physionet.org/content/mcphases/1.0.0/) (menstrual cycle Physiological, Hormonal, and Self-Reported Events and Symptoms) dataset for menstrual health tracking with wearable devices.

Data was collected from 42 menstruating young adults in Canada over two 3-month intervals (one in 2022, and the other in 2024). Participants wore Fitbit Sense smartwatches to measure physiological signals, and Mira Plus Starter Kits to track their hormone levels. Participants also self-reported daily symptom experiences like cramps, sleep quality, and stress levels via a smartphone diary app.

The original dataset contains 23 structured tables organized by signal category. For this project, we focused on the lifestyle factors such as exercise, sleep, and stress, and menstrual cycle symptoms. The datasets we used are the following:

-   Demographics:
    -   `subject_info.csv`: static information such as age, education, and age at menarche
    -   `height_and_weight.csv`: participant's baselien height and weight
-   Hormone and Symptoms:
    -   `hormones_and_selfreport.csv`：self-reported daily data including symptoms (e.g., cramps, mood, menstrual flow) and manually entered hormone levels (LH, E3G, PdG)
-   Lifestyle Factors:
    -   `stress_score.csv` [TODO]
    -   `sleep.csv`: sleep stages, time in bed
    -   `sleep_score.csv`

------------------------------------------------------------------------

In total, we have 4 dataframes:

1.  `subject_info` (demographics data)
2.  `hormone_symptoms` (hormone and symtoms data)
3.  `sleep_stress` (sleep and stress related data)
4.  `exercise` (exercise related data).

For different analyses, we merged the dataframes above by participant `id` as needed.

------------------------------------------------------------------------

### `subject_info` - Subject-Relevant Data

The `subject_info` dataframe contains participants demographics data from `subject_info.csv` and `height_and_weight.csv`, as well as participants study enrollment year (this piece of information is from `hormones_and_selfreport.csv`).

It contains a total of 62 observations of 19 variables. Some key variables are the following:

-   `id`: participant's unique identifier
-   Age relevant variables: `birth_year` and `age_of_first_menarche`
-   Height and weight related variables: `avg_height`, `avg_weight`, `bmi`
-   Study enrollment related information: `study` (flag of which study the participant enrolled in, `1`=2022, `2`=2024, `3`=both), `year` (the year of study)
-   Categorical variables like `ethnicity`, `education`, `self_report_menstrual_health_literacy`, etc.

```{r ht-and-wt, include=FALSE}
ht_wt = read_csv("data/height_and_weight.csv")|> 
  janitor::clean_names() |> 
  # calculate mean height/weight
  rowwise() |>
  mutate(
    avg_height = mean(c(height_2022, height_2024), na.rm = TRUE),
    avg_weight = mean(c(weight_2022, weight_2024), na.rm = TRUE)
  ) |>
  ungroup()
```

```{r, include=FALSE}
# import csv file
hormones_and_selfreport = read_csv("data/hormones_and_selfreport.csv") |> 
  janitor::clean_names() 
# extract study_flag
study_flag <- hormones_and_selfreport  |> 
  distinct(id, study_interval) |> 
  mutate(flag = 1,
         study_interval = paste0("study_", study_interval)) |> 
  pivot_wider(
    names_from = study_interval,
    values_from = flag,
    values_fill = 0  
  )
```

```{r, include=FALSE}
# read in subject-info.csv
subject_info_raw = read_csv("data/subject-info.csv") |> 
  janitor::clean_names()

subject_info <- subject_info_raw  |> 
  # merging
  left_join(ht_wt, by = "id") |> 
  left_join(study_flag, by = "id") |>
  # add a study_flag
  mutate(
    study = case_when(
      study_2022 == 1 & study_2024 == 1 ~ 3L,  # both 2022 & 2024
      study_2022 == 1 & study_2024 == 0 ~ 1L,  
      study_2024 == 1 & study_2022 == 0 ~ 2L,  
      TRUE ~ NA_integer_
    )
  ) |> 
  # pivot_long for wt & ht
  pivot_longer(
    cols = c(weight_2022, weight_2024, height_2022, height_2024),
    names_to  = c(".value", "year"), 
    names_sep = "_"                 
  ) |> 
  rename(
    weight_yr = weight,
    height_yr = height
  ) |> 
  # keep only the relevant study year
  filter(
    (study == 1 & year == 2022) |
    (study == 2 & year == 2024) |
    (study == 3)
  ) |> 
  # calculate age
  mutate(
    year = as.numeric(year),
    birth_year = as.numeric(birth_year),
    age = year - birth_year
  ) |> 
  # get a mean age for each id
  group_by(id) |> 
  mutate(
    mean_age = mean(age, na.rm = TRUE)
  ) |> 
  ungroup() |> 
  # get BMI
  mutate(
    bmi = weight_yr / ( (height_yr / 100)^2 )
  )|>
  # convert NaN to NA
  mutate(
    # 使用 across() 批量处理 avg_wt 和 avg_ht
    across(c(avg_weight, avg_height), 
           ~ if_else(is.nan(.), NA_real_, .))
  ) |> 
  #this factors variables and also creates "gender abrv" and "education abrv", which are simplified versions of these variables for cleaner tables and figures 
  mutate(
    education = str_trim(education),
    education_abrv = case_when(
      education == "High school degree or equivalent (e.g. GED)" ~ "High School",
      education == "Some university/ post-secondary, no degree" ~ "Some College",
      education == "Bachelor's degree (e.g. BA, BS)" ~ "Bachelors",
      education %in% c("Master's degree (e.g. MA, MS, MEd)", "Doctorate or professional degree") ~ "Graduate Degree or Higher",
      TRUE ~ "Other"),
    education_abrv = factor(
      education_abrv,
      levels = c("High School", "Some College", "Bachelors", "Graduate Degree or Higher", "Other"),
      ordered = TRUE),
     self_report_menstrual_health_literacy = factor(
      self_report_menstrual_health_literacy,
      levels = c("Non-existant", "Low", "Medium", "High"),
      ordered = TRUE),
    gender_abrv = case_when(
      gender %in% c("Gender Fluid", "Non-binary") ~ "Gender Fluid or Non-binary", 
      gender %in% c("Prefer not to say", "Other") ~ "Prefer not to say or Other", 
      gender == "Woman" ~ "Woman"),
      gender_abrv = factor(gender_abrv, levels = c("Woman", "Gender Fluid or Non-binary", "Prefer not to say or Other")), 
      sexually_active = factor(sexually_active, levels = c("Yes", "No", "Prefer not to say"))) |> 
  # only need 1 study_interval flag to indicate the study year
  mutate(study_interval = year) |> 
  select(-study_2022, -study_2024, -year, -study) |> 
  # rearrange the column order
  select(
    id,     
    study_interval,     
    everything()
  )
  
```

### `hormone_symptoms` - Hormone & Self-reported Data

[TODO] add overview

```{r, include=FALSE}
# read in raw csv file
hormone_symptoms_raw <- 
  read_csv("data/hormones_and_selfreport.csv") |> 
  janitor::clean_names() 

# factor string values
likert_level_factor = c("not at all", "very low/little", "low", "moderate", "high", "very high")
likert_levels_no_verylowlittle = c("not at all", "very low", "low", "moderate", "high", "very high")
# likert_scale for numeric score conversion
likert_6_levels = c("not at all" = 0, "very low/little" = 1, "very low" = 1, "low" = 2, "moderate" = 3, "high" = 4, "very high" = 5)


hormone_symptoms <- hormone_symptoms_raw
  # convert all to lower case string for standardization
  mutate(across(flow_volume:bloating, 
                ~ ifelse(!is.na(.) & !grepl("^\\d+$", .), tolower(.), .))) |> 
  mutate(across(c(phase), ~ ifelse(!is.na(.) & !grepl("^\\d+$", .), tolower(.), .))) |> 
  # factor variables
  mutate(
    phase = factor(phase, levels = c("menstrual", "follicular", "fertility", "luteal")),
    flow_volume = factor(flow_volume, 
                         levels = c("not at all", "spotting / very light","light","moderate", "somewhat heavy","heavy", "very heavy")),
    flow_color = factor(flow_color,
                        levels = c("not at all", "pink","bright red", "dark brown / dark red", "grey", "black","other")),
  ) |> 
  # factor character values
  mutate(across(
    .cols = c(sleepissue, headaches, stress, cramps, foodcravings, indigestion, bloating, moodswing, sorebreasts, fatigue),  
    .fns = ~ factor(., levels = likert_level_factor),  
    .names = "{.col}"  
  )) |> 
  mutate(across(
    .cols = c(appetite, exerciselevel),
    .fns = ~ factor(., levels = likert_levels_no_verylowlittle), 
    .names = "{.col}"  
  )) |> 
  # convert categorical variable values to numeric intensity scores
  mutate(across(
    .cols = appetite:bloating,
    .fns = ~ recode(., !!!likert_6_levels),
    .names = "{.col}_score"
  )) |> 
  # special conversion for flow
  mutate(
    flow_volume_score = case_when(
      flow_volume == "not at all" ~ 0,
      flow_volume == "spotting / very light" ~ 1,
      flow_volume == "light" ~ 2,
      flow_volume == "moderate" ~ 3,
      flow_volume == "somewhat heavy" ~ 4,
      flow_volume == "heavy" ~ 5,
      flow_volume == "very heavy" ~ 6,
      TRUE ~ NA_real_
    ),
    flow_color_score = case_when(
      flow_color == "not at all" ~ 0,
      flow_color == "pink" ~ 1,
      flow_color == "bright red" ~ 2,
      flow_color == "dark brown / dark red" ~ 3,
      flow_color == "grey" ~ 4,
      flow_color == "black" ~ 5,
      flow_color == "other" ~ 6,
      TRUE ~ NA_real_
    )
  )


hormone_symptoms |> 
  filter(is.na(phase))
```

### `exercise`

```{r, include = FALSE}
# Read data
exercise_raw <- read_csv("data/exercise.csv") |> 
  janitor::clean_names() 

exercise_daily <- exercise_raw |> 
  distinct() |> 
#  select(id, study_interval, start_day_in_study, activityname, duration, activeduration, averageheartrate) |> 
  # Aggregate to daily level
  group_by(id, study_interval, start_day_in_study) %>%
  summarise(
    total_calories = sum(calories, na.rm = TRUE),
    total_duration_min = sum(duration, na.rm = TRUE) / 60000,
    total_active_min = sum(activeduration, na.rm = TRUE) / 60000,
    total_steps = sum(steps, na.rm = TRUE),
    avg_heartrate = mean(averageheartrate, na.rm = TRUE),
    max_heartrate = ifelse(all(is.na(averageheartrate)), NA, max(averageheartrate, na.rm = TRUE)),  # Handling -Inf
    total_elevation = sum(elevationgain, na.rm = TRUE),
    n_sessions = n(),
    activity_types = paste(unique(activityname), collapse = ", "),
    .groups = "drop"
  ) |> 
  rename(day_in_study = start_day_in_study) 
```


### `sleep_stress`
[TODO] add overview

```{r}
# load raw data from csv files
sleep_score_raw <- read_csv("data/sleep_score.csv") |>
  janitor::clean_names()
sleep_raw       <- read_csv("data/sleep.csv") |>
  janitor::clean_names()
stress_score_raw <- read_csv("data/stress_score.csv") |>
  janitor::clean_names()

# combine the sleep and stress score
sleep_score <- sleep_score_raw |>
  select(id,study_interval, day_in_study, overall_score, deep_sleep_in_minutes) |> 
  mutate(sleep_score = overall_score) |> 
  select(-overall_score) |> 
  # remove duplicates by keeping the maximum score
  group_by(id, study_interval, day_in_study) |> 
  slice_max(order_by = sleep_score, n = 1, with_ties = FALSE) |> 
  ungroup()

stress_score <- stress_score_raw |>
  filter(calculation_failed == "FALSE")|>
  select(id, study_interval, day_in_study, stress_score)|>
  distinct(id, study_interval, day_in_study, .keep_all = TRUE)


sleep_stress_score <- full_join(sleep_score, stress_score, by=c("id", "study_interval", "day_in_study"))

# check duplicates >> no duplicates nice
sleep_stress_score %>%
  group_by(id, study_interval, day_in_study) %>%
  filter(n() > 1)

# check of na values
#sum(is.na(sleep_stress$overall_score))
#sum(is.na(sleep_stress$stress_score))

# check how many days have both scores
sleep_stress_score %>%
  filter(!is.na(stress_score) & !is.na(sleep_score)) |> 
  nrow()

# NOT GOING TO USE SLEEP DATA FOR NOW
######################
sleep <- sleep_raw|>
  select(id,study_interval, sleep_end_day_in_study, timeinbed) |>
  # changed to sleep_end_day
  mutate(day_in_study = sleep_end_day_in_study) |>
  select(-sleep_end_day_in_study)
sleep_stress_daily <- full_join(sleep, sleep_stress_score, by=c("id", "study_interval", "day_in_study"))  |> view()
#sleep %>%
 # group_by(id, study_interval, day_in_study) %>%
  #summarise(
   # total_timeinbed = sum(timeinbed, na.rm = TRUE),
    #.groups = "drop"  # 去除分组，返回一个没有分组的 data frame
#  ) |> 
 # filter(total_timeinbed>2000)
  
 # ggplot(aes(x = total_timeinbed)) +
#  geom_density(fill = "skyblue", alpha = 0.5) +  # 填充颜色为淡蓝色，透明度为0.5
#  labs(title = "Density Distribution of Total Time in Bed", 
 #      x = "Total Time in Bed (hours)", 
  #     y = "Density")
```

### Merged Dataset

We used `hormone_symptoms` as our anchor dataframe since all of our outcome variables are from `hormone_symptoms`; hence, we used `left_join` on it. In other words, if a person did not have any hormone/symptoms related data on a given day, she would not have any other types of data on that day (e.g. no exercise/stress/sleep) in the merged dataset called `all_daily_data`.

First merged daily exercise data, then merged daily stress and sleep scores. 

```{r, include=FALSE}

all_daily_data <- hormone_symptoms |> 
  # MERGE exercise & hormone
  left_join(exercise_daily, by = c("id", "study_interval", "day_in_study")) |>
  # add flag exercised_flag for easy filtering in the future analyses
  # only need to keep exercised_flag==1 to have all rows with exercise data
  mutate(
    exercised_flag = ifelse(!is.na(n_sessions) & n_sessions > 0, 1, 0)
    # Replace NA with 0 for days without exercise ## NA might be not wearing the device instead of not exercising, I think it's better to remove them. Converting to 0 might cause very biased (right skewed) data/results
    #total_duration_min = replace_na(total_duration_min, 0),
    #total_active_min = replace_na(total_active_min, 0),
    #n_sessions = replace_na(n_sessions, 0),
  ) |> 
  # Remove individuals with no phase
  # filter(!is.na(phase))

  # MERGE sleep & stress score data
  # noticed hormone_symptoms df has a stress_score column 
  # drop it
  select(-stress_score) |> 
  left_join(sleep_stress_score, by = c("id", "study_interval", "day_in_study")) |> 
  # add flag sleep_stress_flag for easy filtering in the future analyses
  mutate(
    sleep_stress_flag = ifelse(
      !is.na(stress_score) & !is.na(sleep_score),1,0
    )
  )  
  # MERGE demographic data
  # left_join(subject_info, by = c("id", "study_interval")) 
  
```


# EDA


# Modelling

# Discussion



## Limitation


