---
title: "HORMONES & SYMPTOMS: STATISTICAL MODELLING"
output:
  html_document:
    code_folding: hide 
---

```{r, message=FALSE, warning = FALSE, include=FALSE}
# Load packages 
library(tidyverse)
library(ggplot2)
library(modelr)
library(mgcv)
library(dplyr)
library(tidyr)
library(patchwork)
library(lme4)
library(lmerTest)
library(gt)
library(ggsci)
library(knitr)
library(broom.mixed) # for tidy
library(scales)
library(kableExtra)

# Set plot theme
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.discrete.colour = function(...) scale_colour_brewer(..., palette = "Pastel2"),
  ggplot2.discrete.fill   = function(...) scale_fill_brewer(..., palette = "Pastel2"),

  ggplot2.continuous.colour = function(...) scale_colour_distiller(..., palette = "PuRd"),
  ggplot2.continuous.fill   = function(...) scale_fill_distiller(..., palette = "PuRd")
)

hormone_symptoms=
  read_csv("clean_data/hormone_symptoms.csv")|>
  janitor::clean_names()|>
  filter(!is.na(phase) & !is.na(moodswing) & !is.na(fatigue)& !is.na(flow_color)& !is.na(flow_volume)& !is.na(appetite))

# Define the function
create_model_table <- function(model, model_name) {
  tidy_output <- tidy(model, effects = "fixed", conf.int = TRUE)
  p_values <- summary(model)$coefficients[, ncol(summary(model)$coefficients)]
  
  tidy_output |>
    select(term, estimate, std.error, conf.low, conf.high) |>
    mutate(
      p.value = p_values[match(term, names(p_values))],
      significant = ifelse(p.value < 0.05, "Yes", "No"),
      model = model_name
    ) |>
    select(model, everything())
}
```


<br>

This analysis examines whether hormone levels predict menstrual symptom severity. 

<br>

## Mood Swings by Menstrual Phase

We tested whether mood swing severity differs by menstrual phase, accounting for repeated measures within individuals. We chose to fit linear mixed-effects models with random intercepts, as our data violates the independence assumption for standard linear regression, and  to account for repeated measures within participants.

```{r, warning= FALSE}

mood_mixed_model <- lmer(moodswing_score ~ phase + (1 | id), data = hormone_symptoms)


create_model_table(mood_mixed_model, "Mood Swing ~ Phase") |>
  kable(digits = 3,
        col.names = c("Model", "Term", "Estimate", "SE", "CI Lower", "CI Upper", "p-value", "Significant"),
        caption = "Linear Mixed Model: Mood Swing by Menstrual Phase") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)


```

The average mood swing score during the menstrual phase (intercept) is 1.77. Compared to menstruation, symptoms are modestly lower in other phases: the follicular phase shows the largest reduction (-0.37 points), followed by the fertility window (-0.34 points) and the luteal phase (-0.24 points). However, individual differences between participants are substantial — the random effects standard deviation (0.98) is nearly identical to the residual standard deviation (1.00), indicating that individual baseline differences account for as much variance as all other factors combined. While a statistically significant pattern links the menstrual phase to higher mood swing reports, the predominant finding is extensive person-to-person variability.

<br>

## Flow Volume & Luteinizing Hormone (LH)
Exploratory scatter plots suggested an inverse relationship between self-reported flow volume and LH levels. We fit a linear mixed model to formally test this association.

```{r, warning= FALSE}

flow_volume_model <- lmer(flow_volume_score ~ lh + (1 | id), data = hormone_symptoms)


create_model_table(flow_volume_model, "Flow Volume ~ LH") |>
  kable(digits = 3,
        col.names = c("Model", "Term", "Estimate", "SE", "CI Lower", "CI Upper", "p-value", "Significant"),
        caption = "Linear Mixed Model: Flow Volume by LH Level") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```
A significant but modest inverse relationship exists between LH levels and perceived flow volume. For every one-unit increase in LH, flow volume score decreases by 0.011 points (p = 0.001). While statistically significant, this effect is small in magnitude. The model indicates substantial individual differences — within-person variability (residual SD = 1.19) is much greater than between-person differences (intercept SD = 0.45). Therefore, while LH shows a significant inverse association with flow volume, within-person biological and measurement variability remains the dominant feature.

<br>

## Appetite & Estrogen

Based on exploratory visualizations suggesting appetite patterns may follow estrogen levels, we tested whether estrogen directly predicts appetite changes within individuals.
```{r, warning= FALSE}
appetite_model <- lmer(appetite_score ~ estrogen + (1 | id), data = hormone_symptoms)

create_model_table(appetite_model, "Appetite ~ Estrogen") |>
  kable(digits = 3,
        col.names = c("Model", "Term", "Estimate", "SE", "CI Lower", "CI Upper", "p-value", "Significant"),
        caption = "Linear Mixed Model: Appetite by Estrogen Level") |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

The model finds no statistically significant relationship between estrogen levels and appetite scores (p = 0.402). The estimated effect is negligible; for every one-unit increase in estrogen, appetite score increases by only 0.0001 points. The random effects structure reveals that within-person residual variation (SD = 0.73) is nearly twice as large as between-person differences (SD = 0.42), and estrogen does not explain a significant portion of within-person fluctuation.


