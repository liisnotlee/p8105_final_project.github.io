---
title: "hormone"
---
```{r, include=FALSE}
library(tidyverse)
library(ordinal)    
library(broom)

```
```{r, include=FALSE}
hormone=
  read_csv("data/hormones_and_selfreport.csv")
```

##yue's interest: phase, lh, estrogen, moodswing, fatigue

```{r, include=FALSE}
my_int= 
  hormone |>
  select(id,phase, lh, estrogen,fatigue,moodswing)|>
  mutate(
    phase = factor(phase, levels = c("Follicular", "Fertility", "Luteal", "Menstrual")),
    fatigue = factor(fatigue, 
                     levels = c("Low", "Moderate", "High", "Very High", "Not at all")),
    moodswing = factor(moodswing,
                       levels = c("Very Low/Little", "Low", "Moderate", "High","Very High","Not at all"))
  )
phase_order <- c("Menstrual", "Follicular", "Fertility", "Luteal")

```




first, explore relationship between LH and estrogen
```{r, echo = FALSE}
my_int_avg= 
  my_int|>
  group_by(phase)|>
  summarise(
    estrogen_mean = mean(estrogen, na.rm = TRUE),
    lh_mean = mean(lh, na.rm = TRUE)
  )|>
  mutate(phase = factor(phase, levels = phase_order))|>
  filter(!is.na(phase))

# Plot the summarized data
ggplot(my_int_avg, aes(x = phase)) +
  geom_line(aes(y = estrogen_mean, color = "Estrogen", group = 1), size = 1) +
  geom_line(aes(y = lh_mean, color = "LH", group = 1), size = 1) +
  geom_point(aes(y = estrogen_mean, color = "Estrogen"), size = 3) +
  geom_point(aes(y = lh_mean, color = "LH"),size= 3) +
  labs(
    title = "Average Estrogen and LH Levels Across Menstrual Cycle Phases",
    x = "Menstrual Cycle Phase",
    y = "Hormone Level",
    color = "Hormone"
  ) +
  scale_color_manual(values = c("Estrogen" = "red", "LH" = "blue")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
EDA
Average hormone profiles varied systematically across menstrual cycle phases. Estrogen exhibited a clear surge during the Fertility (ovulatory) phase, while LH showed a small peak at the same phase, consistent with the known physiological LH surge that triggers ovulation. Both hormones were relatively low during the Menstrual phase and increased through the Follicular phase before peaking in Fertility, then declining during the Luteal phase. These patterns confirm that the hormonal data capture biologically meaningful endocrine rhythms across the cycle.




fatigue and moodswing


```{r, include=FALSE}
# Remove NA phases AND NA moodswing/fatigue values
my_int_clean=
  my_int |>
  filter(!is.na(phase) & !is.na(moodswing) & !is.na(fatigue))

```


##this two bar graph show the proportion of fatigue and moodswing among four phases, but they are hard to read. 

#so i aim to change the catogorical value (low, moderate, high) to 1,2,3, and so on. i want to sum and avrage. to show a typical cahnge of fatigue and mood in four phases. 

```{r, include=FALSE}
# Convert moodswing and fatigue to numeric intensity scores
my_int_numeric <- my_int_clean %>%
  mutate(
    moodswing_num = case_when(
      moodswing == "Not at all" ~0,
      moodswing == "Very Low/Little" ~ 1,
      moodswing == "Low" ~ 2,
      moodswing == "Moderate" ~ 3,
      moodswing == "High" ~ 4,
      moodswing == "Very High" ~ 5,
      TRUE ~ NA_real_
    ),
    fatigue_num = case_when(
      fatigue == "Not at all" ~0,
      fatigue == "Low" ~ 1,
      fatigue == "Moderate" ~ 2,
      fatigue == "High" ~ 3,
      fatigue == "Very High" ~ 4,
      TRUE ~ NA_real_
    )
  )

# Calculate average intensity by phase
symptom_means <- my_int_numeric %>%
  group_by(phase = factor(phase, levels = phase_order)) %>%
  summarise(
    avg_moodswing = mean(moodswing_num, na.rm = TRUE),
    avg_fatigue = mean(fatigue_num, na.rm = TRUE),
    n = n(),
    .groups = 'drop'
  )

symptom_means
```





```{r, echo = FALSE}
# Mood swing single line plot
ggplot(symptom_means, aes(x = phase, y = avg_moodswing, group = 1)) +
  geom_line(color = "purple", size = 1.5, alpha = 0.7) +
  geom_point(color = "purple", size = 3) +
  geom_text(aes(label = round(avg_moodswing, 2)), vjust = -1, size = 4, fontface = "bold") +
  labs(
    title = "Average Mood Swing Intensity Across Menstrual Cycle Phases",
    subtitle = "Higher values indicate more severe mood swings (Scale: 1-4)",
    x = "Menstrual Cycle Phase",
    y = "Average Mood Swing Intensity"
  ) +
  ylim(0, 4) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
    plot.title = element_text(face = "bold"),
    panel.grid.major = element_line(color = "grey90")
  )
```
```{r, echo = FALSE}
# Fatigue single line plot
ggplot(symptom_means, aes(x = phase, y = avg_fatigue, group = 1)) +
  geom_line(color = "darkorange", size = 1.5, alpha = 0.7) +
  geom_point(color = "darkorange", size = 3) +
  geom_text(aes(label = round(avg_fatigue, 2)), vjust = -1, size = 4, fontface = "bold") +
  labs(
    title = "Average Fatigue Intensity Across Menstrual Cycle Phases",
    subtitle = "Higher values indicate more severe fatigue (Scale: 1-4)",
    x = "Menstrual Cycle Phase",
    y = "Average Fatigue Intensity"
  ) +
  ylim(0, 4) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
    plot.title = element_text(face = "bold"),
    panel.grid.major = element_line(color = "grey90")
  )
```

violin graphs for moodswing
```{r, echo = FALSE}
ggplot(my_int_numeric, aes(x = phase, y = moodswing_num)) +
  geom_violin(trim = TRUE, fill = "orchid", alpha = 0.5) +
  geom_jitter(width = 0.15, alpha = 0.3, size = 1) +
  scale_y_continuous(limits = c(0,5), breaks = 0:5) +
  labs(
    title = "Distribution of Mood Swing Intensity Across Phases",
    x = "Phase",
    y = "Mood Swing (0–5)"
  ) +
  theme_minimal()
```
violin for fatigue
```{r, echo = FALSE}
ggplot(my_int_numeric, aes(x = phase, y = fatigue_num)) +
  geom_violin(trim = TRUE, fill = "orange", alpha = 0.5) +
  geom_jitter(width = 0.15, alpha = 0.3, size = 1) +
  scale_y_continuous(limits = c(0,4), breaks = 0:4) +
  labs(
    title = "Distribution of Fatigue Intensity Across Phases",
    x = "Phase",
    y = "Fatigue (0–4)"
  ) +
  theme_minimal()
```

Both mood swing and fatigue showed clear phase-dependent variation. After converting ordinal symptom ratings into numeric intensity scores, average mood swing and fatigue levels were highest during the Menstrual phase and lowest during the Follicular phase. Violin plots revealed substantial inter-individual variability but consistent right-skewed distributions during Menstrual and Luteal phases, indicating higher symptom burden during these periods.


# approach: longtidual changes


```{r, echo = FALSE}
library(lme4)


# Moodswing model
m1 <- lmer(moodswing_num ~ phase + (1 | id), data = my_int_numeric)
summary(m1)

# Fatigue model
m2 <- lmer(fatigue_num ~ phase + (1 | id), data = my_int_numeric)
summary(m2)

```
Longitudinal Mixed-Effects Modeling of Symptoms

To account for repeated measurements within individuals, linear mixed-effects models with random intercepts for participant ID were fitted. For mood swings, relative to the Follicular phase, the Luteal phase showed a significant increase of approximately +0.13 units (t = 2.49), while the Menstrual phase showed a much larger increase of approximately +0.36 units (t = 5.86). For fatigue, only the Menstrual phase differed significantly from the Follicular phase, with an increase of approximately +0.27 units (t = 4.94); Fertility and Luteal phases showed negligible and non-significant differences. These results demonstrate that within individuals, mood disturbances and fatigue are most strongly elevated during the Menstrual phase.


reletionship between hormone and flow color, flow volume, and appetite

```{r, include=FALSE}
other_interest = 
  hormone |>
  select(id, phase, lh, estrogen, flow_color, flow_volume, appetite) |>
  mutate(
    phase = factor(phase, levels = c("Follicular", "Fertility", "Luteal", "Menstrual")),
    flow_volume = factor(flow_volume, 
                         levels = c("Not at all", "Spotting / Very Light","Light","Moderate",
                                     "Somewhat Heavy","Heavy", "Very Heavy")),
    flow_color = factor(flow_color,
                        levels = c("Not at all", "Pink","Bright Red", "Dark Brown / Dark Red", "Grey", 
                                    "Black","Other")),
    appetite = factor(appetite,
                      levels = c("Very Low","Low",  "Moderate", "High", "Very High"))
  )   

phase_order = c("Menstrual", "Follicular", "Fertility", "Luteal")
colSums(is.na(other_interest[, c("flow_volume", "flow_color", "appetite")]))
  
```

```{r, include=FALSE}
# Flow volume frequencies by phase
table_flow_vol=
  other_interest|>
  filter(!is.na(flow_volume))|>
  count(phase, flow_volume) |>
  group_by(phase)|>
  mutate(pct = n / sum(n) * 100)|>
  arrange(phase)
table_flow_vol

# Flow color
table_flow_color=
  other_interest |>
  filter(!is.na(flow_color))|>
  count(phase, flow_color)|>
  group_by(phase)|>
  mutate(pct = n / sum(n) * 100)
table_flow_color

# Appetite
table_appetite=
  other_interest |>
  filter(!is.na(appetite))|>
  count(phase, appetite)|>
  group_by(phase)|>
  mutate(pct = n / sum(n) * 100)
table_appetite

```


Overall scatter plot for three variables:
```{r, echo = FALSE}

my_i_plot=
  other_interest|>
  filter(!is.na(phase) & (!is.na(flow_volume) | !is.na(flow_color) | !is.na(appetite)))

# Optional: convert ordered factors to numeric for plotting
my_i_plot =
  my_i_plot|>
  mutate(
    flow_volume_num = as.numeric(flow_volume),
    flow_color_num  = as.numeric(flow_color),
    appetite_num    = as.numeric(appetite)
  )

# 1) FLOW VOLUME
ggplot(my_i_plot, aes(x = phase, y = flow_volume_num)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  stat_summary(fun = mean, geom = "point", size = 3, color = "red") +
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "red", size = 1) +
  scale_y_continuous(
    breaks = 1:length(levels(other_interest$flow_volume)),
    labels = levels(other_interest$flow_volume)
  ) +
  labs(title = "Flow Volume Across Menstrual Cycle Phases",
       y = "Flow Volume",
       x = "Phase") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 2) FLOW COLOR
ggplot(my_i_plot, aes(x = phase, y = flow_color_num)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "darkgreen") +
  stat_summary(fun = mean, geom = "point", size = 3, color = "red") +
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "red", size = 1) +
  scale_y_continuous(
    breaks = 1:length(levels(other_interest$flow_color)),
    labels = levels(other_interest$flow_color)
  ) +
  labs(title = "Flow Color Across Menstrual Cycle Phases",
       y = "Flow Color",
       x = "Phase") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 3) APPETITE
ggplot(my_i_plot, aes(x = phase, y = appetite_num)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "purple") +
  stat_summary(fun = mean, geom = "point", size = 3, color = "red") +
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "red", size = 1) +
  scale_y_continuous(
    breaks = 1:length(levels(other_interest$appetite)),
    labels = levels(other_interest$appetite)
  ) +
  labs(title = "Appetite Across Menstrual Cycle Phases",
       y = "Appetite",
       x = "Phase") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, include=FALSE}

#give them order to do the avereage graph
my_i_num =
  other_interest|>
  filter(!is.na(phase))|>
  mutate(
    # Flow volume: example mapping
    flow_volume_num = case_when(
      flow_volume == "Not at all" ~ 0,
      flow_volume == "Spotting / Very Light" ~ 1,
      flow_volume == "Light" ~ 2,
      flow_volume == "Moderate" ~ 3,
      flow_volume == "Somewhat Heavy" ~ 4,
      flow_volume == "Heavy" ~ 5,
      flow_volume == "Very Heavy" ~ 6,
      TRUE ~ NA_real_
    ),
    # Flow color: example mapping
    flow_color_num = case_when(
      flow_color == "Not at all" ~ 0,
      flow_color == "Pink" ~ 1,
      flow_color == "Bright Red" ~ 2,
      flow_color == "Dark Brown / Dark Red" ~ 3,
      flow_color == "Grey" ~ 4,
      flow_color == "Black" ~ 5,
      flow_color == "Other" ~ 6,
      TRUE ~ NA_real_
    ),
    # Appetite: example mapping
    appetite_num = case_when(
      appetite == "Very Low" ~ 0,
      appetite == "Low" ~ 1,
      appetite == "Moderate" ~ 2,
      appetite == "High" ~ 3,
      appetite == "Very High" ~ 4,
      TRUE ~ NA_real_
    )
  )
```

```{r, echo = FALSE}
#graphing
phase_order =
  c("Menstrual", "Follicular", "Fertility", "Luteal")

my_i_avg =
  my_i_num|>
  group_by(phase = factor(phase, levels = phase_order)) |>
  summarise(
    avg_flow_volume = mean(flow_volume_num, na.rm = TRUE),
    avg_flow_color  = mean(flow_color_num, na.rm = TRUE),
    avg_appetite    = mean(appetite_num, na.rm = TRUE),
    .groups = 'drop'
  )

flow_volume_levels <- c("Not at all", "Spotting / Very Light", "Light", "Moderate",
                        "Somewhat Heavy", "Heavy", "Very Heavy")

ggplot(my_i_avg, aes(x = phase, y = avg_flow_volume, group = 1)) +
  geom_line(color = "blue", size = 1.5) +
  geom_point(color = "red", size = 3) +
  geom_text(aes(label = round(avg_flow_volume,2)), vjust = -0.5) +
  scale_y_continuous(limits = c(0,6), breaks = 0:6, labels = flow_volume_levels) +
  labs(title = "Average Flow Volume Across Menstrual Cycle Phases",
       x = "Phase", y = "Flow Volume") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Flow color
flow_color_levels =
  c("Not at all", "Pink", "Bright Red", "Dark Brown / Dark Red",
                       "Grey", "Black", "Other")

ggplot(my_i_avg, aes(x = phase, y = avg_flow_color, group = 1)) +
  geom_line(color = "darkgreen", size = 1.5) +
  geom_point(color = "red", size = 3) +
  geom_text(aes(label = round(avg_flow_color,2)), vjust = -0.5) +
  scale_y_continuous(limits = c(0,6), breaks = 0:6, labels = flow_color_levels) +
  labs(title = "Average Flow Color Across Menstrual Cycle Phases",
       x = "Phase", y = "Flow Color") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Appetite
appetite_levels =
  c("Very Low", "Low", "Moderate", "High", "Very High")

ggplot(my_i_avg, aes(x = phase, y = avg_appetite, group = 1)) +
  geom_line(color = "purple", size = 1.5) +
  geom_point(color = "red", size = 3) +
  geom_text(aes(label = round(avg_appetite,2)), vjust = -0.5) +
  scale_y_continuous(limits = c(0,4), breaks = 0:4, labels = appetite_levels) +
  labs(title = "Average Appetite Across Menstrual Cycle Phases",
       x = "Phase", y = "Appetite") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
add violin data:
```{r, echo = FALSE}
ggplot(my_i_num, aes(x = phase, y = flow_volume_num)) +
  geom_violin(fill = "skyblue", alpha = 0.5, trim = FALSE)
  labs(
    title = "Distribution of Flow Volume Across Phases",
    x = "Phase", y = "Flow Volume (0–6)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
```{r, echo = FALSE}
ggplot(my_i_num, aes(x = phase, y = flow_color_num)) +
  geom_violin(fill = "darkseagreen", alpha = 0.5, trim = FALSE) +
  labs(
    title = "Distribution of Flow Color Across Phases",
    x = "Phase", y = "Flow Color (0–6)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
```{r, echo = FALSE}
ggplot(my_i_num, aes(x = phase, y = appetite_num)) +
  geom_violin(fill = "plum", alpha = 0.5, trim = FALSE) +
  labs(
    title = "Distribution of Appetite Across Phases",
    x = "Phase", y = "Appetite (0–4)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```



#Flow volume & flow color: There are clear differences across menstrual cycle phases. Likely patterns: heavier flow and darker color in the Menstrual phase, lighter/spotting in Follicular/Luteal.

#Appetite:Overall differences across phases are not statistically significant at α = 0.05. There may be a trend, but the variation is smaller or more individual-specific.


To account for within-subject repeated measures and get phase-specific effects, we can fit CLMM models:
```{r, echo = FALSE}
library(ordinal)

# Flow Volume
clmm_flowvol=
  clmm(flow_volume ~ phase + (1 | id), data = other_interest, Hess = TRUE)
summary(clmm_flowvol)

# Flow Color
clmm_flowcolor =
  clmm(flow_color ~ phase + (1 | id), data =other_interest, Hess = TRUE)
summary(clmm_flowcolor)

# Appetite
clmm_app=
  clmm(appetite ~ phase + (1 | id), data = other_interest, Hess = TRUE)
summary(clmm_app)

```
#interpretation:
Flow volume:
The relatively low AIC (3622.83) compared with the other models indicates a strong phase-dependent structure in flow volume.Because flow volume is directly driven by bleeding physiology, the good model fit supports that menstrual phase is the dominant determinant of bleeding intensity.

Flow color:
The lowest AIC across all three models (3486.03) indicates that flow color is even more strongly phase-locked than flow volume.

Appetite: Model converged very well (low gradient, strong Hessian stability).
The random intercept variance for individual appetite baseline was: Variance = 1.398,  SD = 1.183, 42 individuals. This indicates large between-person differences in baseline appetite, confirming the necessity of mixed-effects modeling instead of independent-sample methods.


Conclusion:
Flow volume is strongly structured by menstrual phase, with the cleanest signal among all three outcomes.

Flow color is the most phase-sensitive outcome in your entire dataset, tightly anchored to menstrual cycle transitions.
 
Only the Luteal phase showed a statistically significant increase in appetite relative to the Follicular phase, This estimate is on the log-odds scale, meaning that the odds of reporting higher appetite categories increase substantially in the Luteal phase within the same individuals. Appetite did not differ significantly in the fertility and menstrual phase. This confirms that appetite elevation is a Luteal-specific physiological effect, not a general cycle-wide fluctuation.

Clustering:
```{r, echo = FALSE}
cluster_df =
  my_int_numeric |>
  group_by(id, phase) |>
  summarise(
    lh = mean(lh, na.rm = TRUE),
    estrogen = mean(estrogen, na.rm = TRUE),
    moodswing_num = mean(moodswing_num, na.rm = TRUE),
    fatigue_num = mean(fatigue_num, na.rm = TRUE),
    .groups = "drop"
  ) |>
  left_join(
    my_i_num |>
      group_by(id, phase) |>
      summarise(
        appetite_num = mean(appetite_num, na.rm = TRUE),
        flow_volume_num = mean(flow_volume_num, na.rm = TRUE),
        .groups = "drop"
      ),
    by = c("id", "phase")
  )
cluster_df =
  cluster_df |>
  mutate(
    lh = as.numeric(lh),
    estrogen = as.numeric(estrogen)
  )
cluster_scaled =
  cluster_df |>
  select(-id, -phase) |>
  scale()
set.seed(123)
k3 =
  kmeans(
    cluster_scaled,
    centers = 3,
    nstart = 25
  )

cluster_df =
  cluster_df |>
  mutate(cluster = factor(k3$cluster))
ggplot(cluster_df, aes(x = estrogen, y = lh, color = cluster)) +
  geom_point(size = 2, alpha = 0.7) +
  labs(
    title = "Hormone–Symptom Clusters",
    x = "Estrogen",
    y = "LH",
    color = "Cluster"
  ) +
  theme_minimal()
cluster_summary =
  cluster_df |>
  group_by(cluster) |>
  summarise(across(c(lh, estrogen, moodswing_num, fatigue_num, appetite_num, flow_volume_num), mean))

cluster_summary
```


Unsupervised k-means clustering applied to six standardized features (LH, estrogen, mood swing, fatigue, appetite, and flow volume) identified three distinct physiological–symptom phenotypes:

Cluster 1 (Menstrual–High Symptom–High Flow Group) was characterized by low hormones (LH = 3.82, estrogen = 101.00), the highest mood swing (1.85) and fatigue (2.08), and markedly elevated flow volume (2.45).

Cluster 2 (Ovulatory–High Hormone–High Appetite Group) showed extremely high hormones (LH = 11.47, estrogen = 256.48), the highest appetite (2.14), low mood swing (1.45) and fatigue (1.93), and minimal flow (0.21).

Cluster 3 (Baseline–Low Symptom Group) exhibited moderate hormone levels (LH = 4.58, estrogen = 119.21), the lowest mood swing (1.47) and fatigue (1.82), stable appetite (1.83), and minimal flow (0.15).

These clusters closely align with known biological states of the menstrual cycle, corresponding to menstrual symptomatic states, ovulatory high-hormone states, and baseline low-symptom states.


Overall final results: 
Flow volume and flow color exhibited the strongest phase-locking across the menstrual cycle, while appetite showed a robust, individual-specific increase restricted to the Luteal phase, with substantial between-person variability dominating overall appetite levels.





