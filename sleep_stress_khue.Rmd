---
title: "sleep_stress_EDA"
output: github_document
---

```{r setup , include = FALSE}
library(tidyverse)
library(ggplot2)
library(modelr)
library(mgcv) # for cross validation
library(dplyr)
library(tidyr)
library(patchwork)
library(lme4)
library(lmerTest)
library(rstatix)
library(ggpubr)
library(FSA) # for Dunn test

set.seed(1)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

Load the data 

```{r, include=FALSE}
subject     = read_csv("data/subject-info.csv") |>
  janitor::clean_names()
sleep_score = read_csv("data/sleep_score.csv") |>
  janitor::clean_names()
sleep       = read_csv("data/sleep.csv") |>
  janitor::clean_names()
stress_score = read_csv("data/stress_score.csv") |>
  janitor::clean_names()
hormone = read_csv("data/hormones_and_selfreport.csv") |>
  janitor::clean_names()
exercise = read_csv("data/exercise.csv") |>
  janitor::clean_names()
```


**View the sleep time for different participants in each study interval**
```{r, message=FALSE}
# plot the mean timein bed in hour
sleep |>
  group_by(id, study_interval)|>
  summarize(mean_sleep = mean(timeinbed/60),
            sd_sleep = sd(timeinbed),
            mean_efficiency = mean(efficiency),
            sd_efficiency = sd(efficiency)) |>
  ggplot(aes(x = id, y = mean_sleep, color = id))+
  geom_point()+
  facet_grid(study_interval~.)
```

The average sleep time for each person is different each study interval and varied across participants.  In 2022, some participants slept less than 5 hours and some slept more than 8 hours. In 2024, most participants have better sleep length, 7-8 hours.

Combine the sleep and stress score

```{r, warning=FALSE, message=FALSE}
# join two data sets, using inner join
sleep_score1 = sleep_score |>
  select(id,study_interval, day_in_study, overall_score, deep_sleep_in_minutes)

sleep1 = sleep|>
   select(id,study_interval, sleep_start_day_in_study, timeinbed) |>
   mutate(day_in_study = sleep_start_day_in_study) |>
  select(-sleep_start_day_in_study)
stress_score1 = stress_score |>
  filter(calculation_failed == "FALSE")|>
  select(id, study_interval, day_in_study, stress_score)|>
  distinct(id, study_interval, day_in_study, .keep_all = TRUE)

sleep_stress = inner_join(sleep_score1, stress_score1, join_by("id", "study_interval", "day_in_study"))
 # cleaning exercise from Anu
exercise_clean = exercise|>
  distinct()|>
  select(id, study_interval, start_day_in_study, 
         activityname, calories, duration, activeduration, 
         averageheartrate, steps, elevationgain)

# Aggregate to daily level
exercise_daily = exercise_clean %>%
  group_by(id, study_interval, start_day_in_study) %>%
  summarise(
    total_calories = sum(calories, na.rm = TRUE),
    total_duration_min = sum(duration, na.rm = TRUE) / 60000,
    total_active_min = sum(activeduration, na.rm = TRUE) / 60000,
    total_steps = sum(steps, na.rm = TRUE),
    avg_heartrate = mean(averageheartrate, na.rm = TRUE),
    max_heartrate = max(averageheartrate, na.rm = TRUE),
    total_elevation = sum(elevationgain, na.rm = TRUE),
    n_sessions = n(),
    activity_types = paste(unique(activityname), collapse = ", "),
    .groups = "drop"
  ) %>%
  rename(day_in_study = start_day_in_study)
exercise_daily1 = exercise_daily |>
  select(id, day_in_study, total_active_min, study_interval)
# check of na values
#sum(is.na(sleep_stress$overall_score))
#sum(is.na(sleep_stress$stress_score))
```

Showing the sleep score and stress score changes 

```{r, include = FALSE, warning=FALSE, message=FALSE}
# graphs to show the score across ids
sleep_stress|>
  group_by(id) |> 
  summarize(
    mean_sleep_score = mean(overall_score, na.rm = TRUE),
    mean_stress_score = mean(stress_score, na.rm = TRUE),
    .groups = "drop"
  ) |>
  ggplot(aes(x = id, mean_sleep_score)) +
  geom_point(aes(y = mean_sleep_score, color = "mean_sleep_score"), alpha = 0.5) +
  geom_point(aes(y = mean_stress_score, color = "mean_stress_score"), alpha = 0.5)+
  geom_smooth(aes(y = mean_sleep_score, color = "mean_sleep_score"), se= FALSE )+
  geom_smooth(aes(y = mean_stress_score, color = "mean_stress_score"), se = FALSE) 

```

Load and clean the hormone data for menstrual phases
```{r}
hormone1 = hormone |>
  select(id,phase, day_in_study, lh, estrogen,fatigue,moodswing)|>
  mutate(
    phase = factor(phase, levels = c("Follicular", "Fertility", "Luteal", "Menstrual")),
    fatigue = factor(fatigue, 
                     levels = c("Low", "Moderate", "High", "Very High")),
    moodswing = factor(moodswing,
                       levels = c("Very Low/Little", "Low", "Moderate", "High","Very High","Not at all"))
  )
phase_order <- c("Menstrual", "Follicular", "Fertility", "Luteal")

```

Joined data with the phase in hormone dataset

```{r}
sleep_stress_hormone =
  inner_join(sleep_stress,hormone1, join_by(id, day_in_study))
```

We explore the changes of the stress score with the menstrual cycle. The participants slept best during the menstrual time, probably a good sign to rest well during this time. The lowest sleep score were recorded during ovulation/ fertility time in which the increased estrogen and lh levels may contribute to this low sleep quality. 
The higher stress score the less stressful people experience. In this study, the participants showed the least stressful during folicular period , as the bodies are full of energy. The most stressful time is during luteal period. 


```{r, warning= FALSE}

plot_1 = 
  sleep_stress_hormone |>
  group_by(phase) |>
  summarize(
    mean_sleep_score = mean(overall_score, na.rm = TRUE),
    mean_stress_score = mean(stress_score, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_longer(
    cols = starts_with("mean_"),
    names_to = "metric",
    values_to = "value"
  ) |>
  mutate(
    metric = recode(metric,
                    mean_sleep_score  = "Sleep Score",
                    mean_stress_score = "Stress Score"),
    phase = factor(phase, levels = phase_order)
  ) |>
  ggplot(aes(x = phase, y = value, color = metric, group = metric)) +
    geom_smooth(linewidth= 1) +
    geom_point(size = 3) +
    labs(color = "Metric", y = "Mean Score", x = "Phase") +
    labs(
    x = "Menstrual Cycle Phase",
    y = "Score"
  ) +
    theme_minimal() +
  theme(legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1))

plot_2  =
  sleep_stress_hormone |>
  group_by(phase) |>
  summarize(
    mean_lh = mean(lh, na.rm = TRUE),
    mean_estrogen = mean( estrogen, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_longer(
    cols = starts_with("mean_"),
    names_to = "metric",
    values_to = "value"
  ) |>
  mutate(
    metric = recode(metric,
                    mean_lh           = "LH",
                    mean_estrogen     = "Estrogen"),
    phase = factor(phase, levels = phase_order)
  ) |>
  ggplot(aes(x = phase, y = value, color = metric, group = metric)) +
    geom_smooth(linewidth= 1) +
    geom_point(size = 3) +
    labs(color = "Metric", y = "level", x = "Phase") +
    labs(
    x = "Menstrual Cycle Phase",
    y = "Level"
  ) +
    theme_minimal() +
  theme(legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1))

plot_1+ plot_2
```

**Variation of sleep score across menstrual cycle phases**

We used Kruskal Wallis test to check the differences of the sleep score between different menstrual phases. The post-hoc Dunn Test resulted showed the statistically significant differences in sleep score between Follicular and Fertility, Fertility and menstrual and Luteal and Menstrual. There is no significant differences in sleep score between Fertility vs Luteal or Follicular vs Luteal and Follicular vs Menstrual.

```{r}
kruskal.test(overall_score ~ phase, data = sleep_stress_hormone)
dunnTest(overall_score ~ phase, data = sleep_stress_hormone, method = "bh")

# Dunn test results formatted for ggplot
stat_test <- sleep_stress_hormone %>%
  dunn_test(overall_score ~ phase, p.adjust.method = "BH") %>%
  mutate(
    p.adj = round(p.adj, 3),                # format to 3 digits
    p.adj = ifelse(p.adj < 0.001, "<0.001", p.adj)  # clean LT threshold
  ) |>
  add_xy_position(x = "phase")

sleep_stress_hormone |>
  mutate(phase = factor(phase, levels = phase_order)
         )|>
  ggplot(aes(x = phase, y = overall_score, fill = phase)) +
  geom_violin(alpha = 0.5, trim = FALSE) +
  geom_boxplot(width = 0.15, outlier.size = 0.8) +
  stat_pvalue_manual(
    stat_test,
    label = "p.adj",
    tip.length = 0.01,
    hide.ns = TRUE      # hides non-significant comparisons
  ) +
  labs(
    title = "Sleep Score Across Menstrual Cycle Phases",
    x = "Menstrual Cycle Phase",
    y = "Sleep Score"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

**Variation of stress score across menstrual cycle phases**
Similarly we used Kruskal Wallis and post-hoc Dunn Test to check the significant differences of stress score across menstrual phases. The resuls showed that there are statistically significant differences for stress score across menstrual phases. 


```{r}
kruskal.test(stress_score ~ phase, data = sleep_stress_hormone)
dunnTest(stress_score ~ phase, data = sleep_stress_hormone, method = "bh")

# Dunn test results formatted for ggplot
stat_test2 <- sleep_stress_hormone %>%
  dunn_test(stress_score ~ phase, p.adjust.method = "BH") %>%
  mutate(
    p.adj = round(p.adj, 3),                # format to 3 digits
    p.adj = ifelse(p.adj < 0.001, "<0.001", p.adj)  # clean LT threshold
  ) |>
  add_xy_position(x = "phase")

sleep_stress_hormone |>
  mutate(phase = factor(phase, levels = phase_order)
         )|>
  ggplot(aes(x = phase, y = stress_score, fill = phase)) +
  geom_violin(alpha = 0.5, trim = FALSE) +
  geom_boxplot(width = 0.15, outlier.size = 0.8) +
  stat_pvalue_manual(
    stat_test2,
    label = "p.adj",
    tip.length = 0.01,
    hide.ns = TRUE      # hides non-significant comparisons
  ) +
  labs(
    title = "Sleep Score Across Menstrual Cycle Phases",
    x = "Menstrual Cycle Phase",
    y = "Sleep Score"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```



Explore the variation among different participants. adding the id, ethnicity and birthyear of the subjects.

```{r}

sleep_stress_hormone2 = subject |>
  select(id, birth_year, ethnicity) |>
  full_join(sleep_stress_hormone, join_by(id)) 

```

View the stress and sleep score across menstrual cycle phases for each 

```{r}
sleep_stress_hormone2 |>
  group_by(phase, ethnicity) |>
  summarize(
    mean_sleep_score = mean(overall_score, na.rm = TRUE),
    mean_stress_score = mean(stress_score, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_longer(
    cols = starts_with("mean_"),
    names_to = "metric",
    values_to = "value"
  ) |>
  drop_na()|>
  mutate(
    metric = recode(metric,
                    mean_sleep_score  = "Sleep Score",
                    mean_stress_score = "Stress Score"),
    phase = factor(phase, levels = phase_order)
  ) |>
  ggplot(aes(x = phase, y = value, color = ethnicity, group = ethnicity)) +
    geom_line(size = 1) +
    geom_point(size = 3) +
    facet_grid(~ metric) +
    labs(color = "Ethnicity", y = "Mean Score", x = "Phase") +
    labs(
    title = "stress and sleep score Across Menstrual Cycle Phases",
    x = "Menstrual Cycle Phase",
    y = "score"
  ) +
    theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

**Variation of sleep score and stress score across different ethnicity**
 

```{r}
dodge <- position_dodge(width = 0.5)
sleep_stress_hormone2 |>
  select(id, ethnicity, stress_score, overall_score) |>
  drop_na()|>
  pivot_longer(
    cols = c(stress_score, overall_score),
    names_to = "metric",
    values_to = "value"
  ) |>
  mutate(
    metric = recode(metric,
      overall_score = "Sleep Score",
      stress_score  = "Stress Score",
    )
  ) |>
  ggplot(aes(x = ethnicity, y = value, fill = metric)) +
  geom_violin(position = dodge,alpha = 0.5, trim = TRUE) +
  geom_boxplot(width = 0.5, alpha= 0.1)+
    labs(y = "Score", fill = "Metric") +
  facet_grid(~metric)

```



```{r, include=FALSE}
sleep_stress_hormone_add =
  sleep_score1 |>
    inner_join(hormone1,      by = join_by(id, day_in_study)) |>
    inner_join(sleep1,        by = join_by(id, study_interval, day_in_study)) |>
    inner_join(stress_score1, by = join_by(id, study_interval, day_in_study)) |>
    inner_join(exercise_daily1, by = join_by(id, study_interval, day_in_study))

# create a table
sleep_stress_hormone_add |>
  group_by(phase, id) |>
  summarize(
    timeinbed = mean(timeinbed/60)
  )|>
  pivot_wider(names_from = phase,
              values_from = timeinbed) |>
  knitr::kable(title = "average time in bed", digits = 1)
```

**Time in bed variation across menstrual phases**


```{r}
sleep_stress_hormone_add |>
  group_by(phase, id) |>
  summarize(
    timeinbed = mean(timeinbed/60)
  )|> 
   mutate(phase = factor(phase, levels = phase_order))|>
  ggplot(aes(x = phase, y = timeinbed, fill = phase)) +
  geom_violin(alpha = 0.5) +
  geom_boxplot(width = 0.2) +
  labs(
    title = "Sleep time Across Menstrual Cycle Phases",
    x = "Menstrual Cycle Phase",
    y = "Time in bed (hrs)"
  ) +
    theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

See the correlation in sleep score file
```{r}
sleep_score |>
  group_by(id)|>
  summarise(mean_deep_sleep = mean(deep_sleep_in_minutes),
            mean_overall_score = mean(overall_score))|>
  ggplot(aes(x= mean_overall_score, y = mean_deep_sleep )) +
  geom_point()
```


NOT WORKING_try to put all in one scale
```{r, include= FALSE}

sleep_stress_hormone_plot = 
  sleep_stress_hormone |>
  group_by(phase) |>
  summarize(
    mean_sleep_score = mean(overall_score, na.rm = TRUE),
    mean_stress_score = mean(stress_score, na.rm = TRUE),
    mean_lh = mean(lh, na.rm = TRUE),
    mean_estrogen = mean( estrogen, na.rm = TRUE),
    .groups = "drop"
  ) 
### create new vars
left_vars  <- c("mean_sleep_score", "mean_stress_score")
right_vars <- c("mean_lh")
### scale
scaleFactor <- max(sleep_stress_hormone_plot[, right_vars], na.rm = TRUE)/
               max(sleep_stress_hormone_plot[, left_vars],  na.rm = TRUE)
scaleFactor2 = max(sleep_stress_hormone_plot[,"mean_estrogen"])/ max(sleep_stress_hormone_plot[,"mean_stress_score"])
## create plot
sleep_stress_hormone_plot|>
   pivot_longer(cols = starts_with("mean"),
               names_to = "metric",
               values_to = "value")|>
    mutate(phase = factor(phase, levels = phase_order),
    value_plot = case_when(metric == "mean_lh" ~ value / scaleFactor,  # scale lh up
                           metric == "mean_estrogen" ~ value/scaleFactor2,
                           metric %in% c("mean_sleep_score", "mean_stress_score") ~ value -30)
    )|>
  ggplot(aes(x = phase))+
  geom_smooth(aes(y = value_plot, color = metric, group = metric), size = 1) +
    scale_y_continuous(
    name = "Sleep & Stress Score (left axis)",
    #limits = c(65, 80),                #range of sleep score
    sec.axis = sec_axis( ~ . * scaleFactor,
  name = "Hormone Levels (LH & Estrogen)",
  breaks = c(0, 10, 50, 100))) +
  scale_color_manual(
    values = c(
      "mean_sleep_score" = "blue",
      "mean_stress_score" = "darkgreen",
      "mean_lh" = "red",
      "mean_estrogen" = "purple"
    )
  ) +
  theme_minimal(base_size = 14) 

```


See time in bed and deep sleep vs menstrual cycle

```{r, warning=FALSE}
coeff = 5.5 # 5 is the best overlap
timeinbed_color = "red"
deep_sleep_color = "blue"
plot_3 = sleep_stress_hormone_add |>
  mutate(phase = factor(phase, levels = phase_order))|>
  group_by(phase)|>
   summarize(timeinbed = mean(timeinbed/60, na.rm = TRUE),
             deep_sleep_in_minutes = mean((deep_sleep_in_minutes/60)*coeff, na.rm = TRUE)
             )|>
   ggplot(aes(x= phase)) +
  geom_smooth(aes(y = timeinbed,group = 1), color = timeinbed_color, linewidth = 0.8) +
  geom_smooth(aes( y = deep_sleep_in_minutes, group = 1), color = deep_sleep_color, linewidth = 0.8)+
  scale_y_continuous(
    
    # Features of the first axis
    name = "Time in bed (hours)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./coeff, name="Deep sleep (hours)")
  ) +
  theme(
    axis.title.y = element_text(color = timeinbed_color, size=13),
    axis.title.y.right = element_text(color = deep_sleep_color, size=13),
    axis.text = element_text(angle = 45, hjust = 1)
  )
plot_3
plot_1 + plot_2 + plot_3
```
 
Mesntruators spent more time in bed during menstrual time but their deep sleep hours were lowest. This showed that the physical exhaustion during menstrual days requiring them to rest but preventing them from having a restorative sleep quality. Follicular time is the when menstruators feel most energetic and spent less time in bed but having much better deep sleep. 


```{r}
coeff = 1 # 5 is the best overlap
total_active_min_color= "red"
stress_score_color = "blue"
sleep_stress_hormone_add |>
  mutate(phase = factor(phase, levels = phase_order))|>
  group_by(phase)|>
   summarize(total_active_min = mean(total_active_min, na.rm = TRUE),
             stress_score = mean(stress_score*coeff, na.rm = TRUE)
             )|>
   ggplot(aes(x= phase)) +
  geom_line(aes(y = total_active_min,group = 1), color = total_active_min_color, linewidth = 0.8) +
  geom_line(aes( y = stress_score , group = 1), color = deep_sleep_color, linewidth = 0.8)+
  scale_y_continuous(
    
    # Features of the first axis
    name = "Active time(minutes))",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./coeff, name="Stress score")
  ) +
  theme(
    axis.title.y = element_text(color = total_active_min_color, size=13),
    axis.title.y.right = element_text(color = stress_score_color, size=13)
  )
```
We need to check if the exercise activities/ time link to stress score?

We have 
`stress score`, `sleep score`, `phase`, `excersise time`, `estrogen`, `lh`

We can try to predict the stress score based on phase, time in bed, deep sleep time?
Is there a way to link exercise vs symptom? Maybe Anu did this analysis?
Do we include study_interval as the random effect? Maybe not.
```{r}
#  model
m1 <- lmer(stress_score ~ phase + timeinbed + total_active_min +(1 | id) + moodswing, data = sleep_stress_hormone_add)
summary(m1) 
# etracting coefficient
coefficients_values = fixed.effects(m1)
intercept_values = random.effects(m1)
fitted_stress_score = fitted.values(m1)
# check the residuals
qqnorm(residuals(m1)) 

```


**look at the sleep dataset**
```{r}
sleep1 |>
  filter(id==1) |>
  group_by(day_in_study) |>
  summarise(
    total_sleep_hr = sum(timeinbed/60), .groups = "drop")
```

```{r}
sleep1|>
  filter(id == 1) |>
  distinct(day_in_study)
```
 

