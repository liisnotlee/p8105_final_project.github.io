---
title: "Data"
author: "Muying Li"
date: "2025-11-30"
output: html_document
---

# Data Sources 
We utilized the inclusive, multimodal, longitudinal, and de-identified [mcPHASES](https://physionet.org/content/mcphases/1.0.0/) (menstrual cycle Physiological, Hormonal, and Self-Reported Events and Symptoms) dataset  for menstrual health tracking with wearable devices. 

Data was collected from 42 menstruating young adults in Canada over two 3-month intervals (one in 2022, and the other in 2024). Participants wore Fitbit Sense smartwatches to measure physiological signals, and Mira Plus Starter Kits to track their hormone levels. Participants also self-reported daily symptom experiences like cramps, sleep quality, and stress levels via a smartphone diary app. 

The original dataset contains 23 structured tables organized by signal category. For this project, we focused on the lifestyle factors such as exercise, sleep, and stress, and menstrual cycle symptoms. The datasets we used are the following:

- Demographics:
  - `subject_info.csv`: static information such as age, education, and age at menarche
  - `height_and_weight.csv`: participant's baselien height and weight 
- Hormone and Symptoms: 
  - `hormones_and_selfreport.csv`ï¼šself-reported daily data including symptoms (e.g., cramps, mood, menstrual flow) and manually entered hormone levels (LH, E3G, PdG)
- Lifestyle Factors:
  - `stress_score.csv`
  - `sleep.csv`: sleep stages, time in bed
  - `sleep_score.csv`


# Data Cleaning 
Load libraries
```{r load-lib, results='hide'}
library(tidyverse)
library(patchwork)
library(ggsci)
```

## `subj` - Subject-Relevant Data
### `ht_wt` - Subject height and weight 
- `id`
- `height`: mean height
- `weight`: mean weight
- `enrollment_year`: some participants were enrolled in both 2022 and 2024, keep the latest one as enrollment year
- `height_2022`
- `height_2024`
- `weight_2022`
- `weight_2024`

Process:

1. Take the mean for subjects who have multiple heights and weights (both in 2022 and 2024), take the mean.
2. Note missing data
```{r ht-and-wt}
ht_wt = read_csv("data/height_and_weight.csv")|> 
  janitor::clean_names() |> 
  # calculate mean height/weight
  rowwise() |>
  mutate(
    avg_height = mean(c(height_2022, height_2024), na.rm = TRUE),
    avg_weight = mean(c(weight_2022, weight_2024), na.rm = TRUE)
  ) |>
  ungroup()
```

Count how many missing values:
```{r missing-value-ht-wt}
ht_wt |>
  summarise(
    missing_ht = sum(is.na(avg_height)),
    missing_wt = sum(is.na(avg_weight)),
    missing_both = sum(is.na(avg_weight) & is.na(avg_height))
  )

ht_wt |>
  filter(is.na(avg_height) | is.na(avg_weight))
```

### `hormones_and_selfreport` - hormone and self-reported data
```{r}
hormones_and_selfreport = read_csv("data/hormones_and_selfreport.csv") |> 
  janitor::clean_names() 
```

Get participants study enrollment info:

- `id`
- `study_2022`: whether enrolled in 2022 (1=Yes, 0=No)
- `study_2024`: whether enrolled in 2024 (1=Yes, 0=No)
```{r}
study_flag <- hormones_and_selfreport  |> 
  distinct(id, study_interval) |> 
  mutate(flag = 1,
         study_interval = paste0("study_", study_interval)) |> 
  pivot_wider(
    names_from = study_interval,
    values_from = flag,
    values_fill = 0  
  )
```

### `subject_info` - subject information 
```{r}
# read in csv
subject_info_raw = read_csv("data/subject-info.csv") |> 
  janitor::clean_names()
```

Process:
1. merge with `ht_wt` and `study_flag`
2. `pivot_long` for ht, wt, and study (1=2022, 2=2024, 3=2025)
3. calculate age based on enrollment study year
4. calculate BMI
```{r}
subject_info <- subject_info_raw  |> 
  # merging
  left_join(ht_wt, by = "id") |> 
  left_join(study_flag, by = "id") |>
  # add a study_flag
  mutate(
    study = case_when(
      study_2022 == 1 & study_2024 == 1 ~ 3L,  # both 2022 & 2024
      study_2022 == 1 & study_2024 == 0 ~ 1L,  
      study_2024 == 1 & study_2022 == 0 ~ 2L,  
      TRUE ~ NA_integer_
    )
  ) |> 
  # pivot_long for wt & ht
  pivot_longer(
    cols = c(weight_2022, weight_2024, height_2022, height_2024),
    names_to  = c(".value", "year"), 
    names_sep = "_"                 
  ) |> 
  rename(
    weight_yr = weight,
    height_yr = height
  ) |> 
  # keep only the relevant study year
  filter(
    (study == 1 & year == 2022) |
    (study == 2 & year == 2024) |
    (study == 3)
  ) |> 
  # calculate age
  mutate(
    year = as.numeric(year),
    birth_year = as.numeric(birth_year),
    age = year - birth_year
  ) |> 
  # get a mean age for each id
  group_by(id) |> 
  mutate(
    mean_age = mean(age, na.rm = TRUE)
  ) |> 
  ungroup() |> 
  # get BMI
  mutate(
    bmi = weight_yr / ( (height_yr / 100)^2 )
  )
```



